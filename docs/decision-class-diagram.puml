@startuml
' PHPDecide - Class diagram (overview)
' Includes: Decision domain + Explain + AI + CLI

skinparam shadowing false
skinparam classAttributeIconSize 0
skinparam linetype ortho

set namespaceSeparator ::

title PHPDecide - Class Diagram (src)

package PhpDecide::Config {
  class PhpDecideDefaults {
    {static} +DECISIONS_DIR: string
  }
}

package Symfony::Console {
  abstract class Command <<Symfony>>
}

package Symfony::Yaml {
  class Yaml <<Symfony>>
  class ParseException <<Symfony>>
}

package PhpDecide::Decision {

  class Decision {
    +__construct(
      id: DecisionId,
      title: string,
      status: DecisionStatus,
      date: DateTimeImmutable,
      scope: Scope,
      content: DecisionContent,
      examples: Examples,
      rules: Rules?,
      aiMetadata: AiMetadata? = null,
      references: References? = null
    )
    +id(): DecisionId
    +title(): string
    +status(): DecisionStatus
    +isActive(): bool
    +date(): DateTimeImmutable
    +scope(): Scope
    +content(): DecisionContent
    +examples(): Examples
    +rules(): Rules?
    +aiMetadata(): AiMetadata?
    +references(): References?
  }

  class DecisionId {
    +__construct(value: string)
    +fromString(value: string): DecisionId
    +value(): string
    +equals(other: DecisionId): bool
  }

  enum DecisionStatus {
    ACTIVE
    DEPRECATED
    SUPERSEDED
    +isActive(): bool
  }

  class Scope {
    +__construct(type: ScopeType, paths: array = [])
    +type(): ScopeType
    +paths(): array
    +appliesTo(path: string): bool
  }

  enum ScopeType {
    GLOBAL
    PATH
    MODULE
  }

  class DecisionContent {
    +__construct(summary: string, rationale: array, alternatives: array = [])
    +summary(): string
    +rationale(): array
    +alternatives(): array
  }

  class Examples {
    +__construct(allowed: array = [], forbidden: array = [])
    +allowed(): array
    +forbidden(): array
  }

  class Rules {
    +__construct(forbid: array = [], allow: array = [])
    +forbid(): array
    +allow(): array
    +hasRules(): bool
  }

  class AiMetadata {
    +__construct(explainStyle: string, keywords: array = [])
    +explainStyle(): string
    +keywords(): array
  }

  class References {
    +__construct(issues: array, commits: array, adr: string?)
    +empty(): References
    +issues(): array
    +commits(): array
    +adr(): string?
  }

  interface DecisionLoader {
    +load(): iterable
  }

  class YamlDecisionLoader {
    +__construct(directory: string)
    +load(): iterable
  }

  interface DecisionRepository {
    +all(): array
    +active(): array
    +findById(id: DecisionId): Decision?
    +applicableTo(path: string): array
    +searchByKeyword(keyword: string): array
  }

  class FileDecisionRepository {
    +__construct(loader: DecisionLoader)
    +all(): array
    +active(): array
    +findById(id: DecisionId): Decision?
    +applicableTo(path: string): array
    +searchByKeyword(keyword: string): array
  }

  class DecisionFactory {
    {static} +fromArray(data: array): Decision
  }
}

package PhpDecide::AI {

  interface AiClient {
    +explainDecision(question: string, decisions: array): string
  }

  class AiClientConfig {
    +__construct(
      apiKey: string,
      model: string,
      baseUrl: string,
      chatCompletionsPath: string,
      timeoutSeconds: int,
      authHeaderName: string,
      authPrefix: string,
      organization: string?,
      project: string?,
      systemPromptOverride: string?,
      caInfoPath: string?,
      insecureSkipVerify: bool
    )
    {static} +fromEnvironment(): AiClientConfig?
  }

  class AiClientFactory {
    {static} +fromEnvironment(httpClient: PhpDecide::AI::Http::HttpClient? = null): AiClient?
    {static} +fromConfig(config: AiClientConfig, httpClient: PhpDecide::AI::Http::HttpClient? = null): AiClient
  }

  class OpenAiChatCompletionsClient {
    +__construct(
      apiKey: string,
      model: string,
      baseUrl: string = "https://api.openai.com",
      chatCompletionsPath: string = "/v1/chat/completions",
      authHeaderName: string = "Authorization",
      authPrefix: string = "Bearer ",
      timeoutSeconds: int = 20,
      organization: string? = null,
      project: string? = null,
      systemPromptOverride: string? = null,
      caInfoPath: string? = null,
      insecureSkipVerify: bool = false,
      httpClient: PhpDecide::AI::Http::HttpClient? = null
    )
    +explainDecision(question: string, decisions: array): string
  }

  class AiClientException
}

package PhpDecide::AI::Http {
  interface HttpClient {
    +post(url: string, headers: array, body: string, timeoutSeconds: int, caInfoPath: string? = null): HttpResponse
  }

  class HttpResponse {
    +__construct(statusCode: int, body: string)
  }

  class CurlHttpClient {
    +post(url: string, headers: array, body: string, timeoutSeconds: int, caInfoPath: string? = null): HttpResponse
  }
}

package PhpDecide::Explain {

  interface AiExplainer {
    +explain(question: string, decisions: array): string
  }

  class AiClientExplainer {
    +__construct(client: PhpDecide::AI::AiClient)
    +explain(question: string, decisions: array): string
  }

  class ExplainService {
    +__construct(repository: PhpDecide::Decision::DecisionRepository, aiExplainer: AiExplainer? = null)
    +explain(question: string, path: string? = null): Explanation
  }

  class DecisionMatcher {
    +__construct(repository: PhpDecide::Decision::DecisionRepository)
    +match(question: string): array
  }

  class Explanation {
    +__construct(decisions: array, message: string)
    +decisions(): array
    +message(): string
    +hasDecisions(): bool
  }
}

package PhpDecide::CLI {

  class ExplainCommand {
    +execute(input, output): int
  }

  class DecisionsLintCommand {
    +execute(input, output): int
  }
}

' --- Composition / Aggregation relationships ---
Decision *-- "1" DecisionId : id
Decision *-- "1" DecisionContent : content
Decision *-- "1" Examples : examples
Decision *-- "1" Scope : scope
Decision --> "1" DecisionStatus : status
Decision o-- "0..1" Rules : rules
Decision o-- "0..1" AiMetadata : aiMetadata
Decision o-- "0..1" References : references

Scope --> "1" ScopeType : type

' --- Interfaces / implementations ---
YamlDecisionLoader ..|> DecisionLoader
FileDecisionRepository ..|> DecisionRepository
OpenAiChatCompletionsClient ..|> PhpDecide::AI::AiClient
AiClientExplainer ..|> PhpDecide::Explain::AiExplainer
CurlHttpClient ..|> PhpDecide::AI::Http::HttpClient

' --- Inheritance ---
PhpDecide::CLI::ExplainCommand --|> Symfony::Console::Command
PhpDecide::CLI::DecisionsLintCommand --|> Symfony::Console::Command

' --- Dependencies (usage) ---
FileDecisionRepository ..> DecisionLoader
FileDecisionRepository ..> Decision
FileDecisionRepository ..> DecisionId
DecisionFactory ..> Decision
AiClientFactory ..> AiClientConfig
AiClientFactory ..> PhpDecide::AI::Http::HttpClient
AiClientFactory ..> OpenAiChatCompletionsClient
OpenAiChatCompletionsClient o-- "1" PhpDecide::AI::Http::HttpClient : httpClient
CurlHttpClient ..> PhpDecide::AI::Http::HttpResponse
DecisionFactory ..> DecisionId
DecisionFactory ..> DecisionStatus
DecisionFactory ..> Scope
DecisionFactory ..> ScopeType
DecisionFactory ..> DecisionContent
DecisionFactory ..> Examples
DecisionFactory ..> Rules
DecisionFactory ..> AiMetadata
DecisionFactory ..> References

PhpDecide::CLI::ExplainCommand ..> PhpDecideDefaults
PhpDecide::CLI::ExplainCommand ..> YamlDecisionLoader
PhpDecide::CLI::ExplainCommand ..> FileDecisionRepository
PhpDecide::CLI::ExplainCommand ..> PhpDecide::Explain::ExplainService
PhpDecide::CLI::ExplainCommand ..> PhpDecide::AI::AiClientFactory
PhpDecide::CLI::ExplainCommand ..> PhpDecide::Explain::AiClientExplainer

PhpDecide::CLI::DecisionsLintCommand ..> PhpDecideDefaults
PhpDecide::CLI::DecisionsLintCommand ..> DecisionFactory
PhpDecide::CLI::DecisionsLintCommand ..> Symfony::Yaml::Yaml
PhpDecide::CLI::DecisionsLintCommand ..> Symfony::Yaml::ParseException

PhpDecide::Explain::ExplainService *-- PhpDecide::Explain::DecisionMatcher
PhpDecide::Explain::ExplainService ..> PhpDecide::Decision::DecisionRepository
PhpDecide::Explain::ExplainService ..> PhpDecide::Explain::AiExplainer

PhpDecide::Explain::DecisionMatcher ..> PhpDecide::Decision::DecisionRepository
PhpDecide::Explain::DecisionMatcher ..> PhpDecide::Decision::Decision
PhpDecide::Explain::Explanation o-- "0..*" PhpDecide::Decision::Decision

PhpDecide::AI::AiClientFactory ..> OpenAiChatCompletionsClient
OpenAiChatCompletionsClient ..> PhpDecide::Decision::Decision
OpenAiChatCompletionsClient ..> AiClientException

@enduml
